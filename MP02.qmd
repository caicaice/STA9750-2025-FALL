---
title: "mp02"
---

## Intor
This a  research investigates housing affordability across U.S. cities, analyzing how the "YIMBY" (Yes In My Backyard) movement influences zoning and housing policy. Inspired by the work of Ray Delahanty (CityNerd), the project leverages alternative data—such as census figures and real estate indices—to pinpoint the most "YIMBY-forward" cities where policies are effectively increasing the supply of affordable housing. By employing data analysis, visualization, and summary techniques, the study culminates in a policy brief that proposes a federal incentive program to encourage YIMBY principles. Ultimately, it demonstrates how data-informed insights can shape effective political and policy strategies to tackle the housing affordability crisis.

## Data Acquisition
```{r}
if(!require(gghighlight)) install.packages("gghighlight")
library(gghighlight)

if(!dir.exists(file.path("data", "mp02"))){
    dir.create(file.path("data", "mp02"), showWarnings=FALSE, recursive=TRUE)
}

library <- function(pkg){
    ## Mask base::library() to automatically install packages if needed
    ## Masking is important here so downlit picks up packages and links
    ## to documentation
    pkg <- as.character(substitute(pkg))
    options(repos = c(CRAN = "https://cloud.r-project.org"))
    if(!require(pkg, character.only=TRUE, quietly=TRUE)) install.packages(pkg)
    stopifnot(require(pkg, character.only=TRUE, quietly=TRUE))
}

library(tidyverse)
library(glue)
library(readxl)
library(tidycensus)

get_acs_all_years <- function(variable, geography="cbsa",
                              start_year=2009, end_year=2023){
    fname <- glue("{variable}_{geography}_{start_year}_{end_year}.csv")
    fname <- file.path("data", "mp02", fname)
    
    if(!file.exists(fname)){
        YEARS <- seq(start_year, end_year)
        YEARS <- YEARS[YEARS != 2020] # Drop 2020 - No survey (covid)
        
        ALL_DATA <- map(YEARS, function(yy){
            tidycensus::get_acs(geography, variable, year=yy, survey="acs1") |>
                mutate(year=yy) |>
                select(-moe, -variable) |>
                rename(!!variable := estimate)
        }) |> bind_rows()
        
        write_csv(ALL_DATA, fname)
    }
    
    read_csv(fname, show_col_types=FALSE)
}

# Household income (12 month)
INCOME <- get_acs_all_years("B19013_001") |>
    rename(household_income = B19013_001)

# Monthly rent
RENT <- get_acs_all_years("B25064_001") |>
    rename(monthly_rent = B25064_001)

# Total population
POPULATION <- get_acs_all_years("B01003_001") |>
    rename(population = B01003_001)

# Total number of households
HOUSEHOLDS <- get_acs_all_years("B11001_001") |>
    rename(households = B11001_001)
```

# the number of new housing units built each year
```{r}
get_building_permits <- function(start_year = 2009, end_year = 2023){
    fname <- glue("housing_units_{start_year}_{end_year}.csv")
    fname <- file.path("data", "mp02", fname)
    
    if(!file.exists(fname)){
        HISTORICAL_YEARS <- seq(start_year, 2018)
        
        HISTORICAL_DATA <- map(HISTORICAL_YEARS, function(yy){
            historical_url <- glue("https://www.census.gov/construction/bps/txt/tb3u{yy}.txt")
                
            LINES <- readLines(historical_url)[-c(1:11)]

            CBSA_LINES <- str_detect(LINES, "^[[:digit:]]")
            CBSA <- as.integer(str_sub(LINES[CBSA_LINES], 5, 10))

            PERMIT_LINES <- str_detect(str_sub(LINES, 48, 53), "[[:digit:]]")
            PERMITS <- as.integer(str_sub(LINES[PERMIT_LINES], 48, 53))
            
            data_frame(CBSA = CBSA,
                       new_housing_units_permitted = PERMITS, 
                       year = yy)
        }) |> bind_rows()
        
        CURRENT_YEARS <- seq(2019, end_year)
        
        CURRENT_DATA <- map(CURRENT_YEARS, function(yy){
            current_url <- glue("https://www.census.gov/construction/bps/xls/msaannual_{yy}99.xls")
            
            temp <- tempfile()
            
            download.file(current_url, destfile = temp, mode="wb")
            
            fallback <- function(.f1, .f2){
                function(...){
                    tryCatch(.f1(...), 
                             error=function(e) .f2(...))
                }
            }
            
            reader <- fallback(read_xlsx, read_xls)
            
            reader(temp, skip=5) |>
                na.omit() |>
                select(CBSA, Total) |>
                mutate(year = yy) |>
                rename(new_housing_units_permitted = Total)
        }) |> bind_rows()
        
        ALL_DATA <- rbind(HISTORICAL_DATA, CURRENT_DATA)
        
        write_csv(ALL_DATA, fname)
        
    }
    
    read_csv(fname, show_col_types=FALSE)
}

PERMITS <- get_building_permits()
```
# download the latest NAICS data schema and manipulate it into a format suitable
```{r}
library(httr2)
library(rvest)
get_bls_industry_codes <- function(){
    fname <- file.path("data", "mp02", "bls_industry_codes.csv")
    library(dplyr)
    library(tidyr)
    library(readr)
    
    if(!file.exists(fname)){
        
        resp <- request("https://www.bls.gov") |> 
            req_url_path("cew", "classifications", "industry", "industry-titles.htm") |>
            req_headers(`User-Agent` = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0") |> 
            req_error(is_error = \(resp) FALSE) |>
            req_perform()
        
        resp_check_status(resp)
        
        naics_table <- resp_body_html(resp) |>
            html_element("#naics_titles") |> 
            html_table() |>
            mutate(title = str_trim(str_remove(str_remove(`Industry Title`, Code), "NAICS"))) |>
            select(-`Industry Title`) |>
            mutate(depth = if_else(nchar(Code) <= 5, nchar(Code) - 1, NA)) |>
            filter(!is.na(depth))
        
        # These were looked up manually on bls.gov after finding 
        # they were presented as ranges. Since there are only three
        # it was easier to manually handle than to special-case everything else
        naics_missing <- tibble::tribble(
            ~Code, ~title, ~depth, 
            "31", "Manufacturing", 1,
            "32", "Manufacturing", 1,
            "33", "Manufacturing", 1,
            "44", "Retail", 1, 
            "45", "Retail", 1,
            "48", "Transportation and Warehousing", 1, 
            "49", "Transportation and Warehousing", 1
        )
        
        naics_table <- bind_rows(naics_table, naics_missing)
        
        naics_table <- naics_table |> 
            filter(depth == 4) |> 
            rename(level4_title=title) |> 
            mutate(level1_code = str_sub(Code, end=2), 
                   level2_code = str_sub(Code, end=3), 
                   level3_code = str_sub(Code, end=4)) |>
            left_join(naics_table, join_by(level1_code == Code)) |>
            rename(level1_title=title) |>
            left_join(naics_table, join_by(level2_code == Code)) |>
            rename(level2_title=title) |>
            left_join(naics_table, join_by(level3_code == Code)) |>
            rename(level3_title=title) |>
            select(-starts_with("depth")) |>
            rename(level4_code = Code) |>
            select(level1_title, level2_title, level3_title, level4_title, 
                   level1_code,  level2_code,  level3_code,  level4_code) |>
            drop_na() |>
            mutate(across(contains("code"), as.integer))
        
        write_csv(naics_table, fname)
    }
    
    read_csv(fname, show_col_types=FALSE)
}

INDUSTRY_CODES <- get_bls_industry_codes()
```
# the BLS Quarterly Census of Employment and Wages
```{r}
library(httr2)
library(rvest)
get_bls_qcew_annual_averages <- function(start_year=2009, end_year=2023){
    fname <- glue("bls_qcew_{start_year}_{end_year}.csv.gz")
    fname <- file.path("data", "mp02", fname)
    
    YEARS <- seq(start_year, end_year)
    YEARS <- YEARS[YEARS != 2020] # Drop Covid year to match ACS
    
    if(!file.exists(fname)){
        ALL_DATA <- map(YEARS, .progress=TRUE, possibly(function(yy){
            fname_inner <- file.path("data", "mp02", glue("{yy}_qcew_annual_singlefile.zip"))
            
            if(!file.exists(fname_inner)){
                request("https://www.bls.gov") |> 
                    req_url_path("cew", "data", "files", yy, "csv",
                                 glue("{yy}_annual_singlefile.zip")) |>
                    req_headers(`User-Agent` = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0") |> 
                    req_retry(max_tries=5) |>
                    req_perform(fname_inner)
            }
            
            if(file.info(fname_inner)$size < 755e5){
                warning(sQuote(fname_inner), "appears corrupted. Please delete and retry this step.")
            }
            
            read_csv(fname_inner, 
                     show_col_types=FALSE) |> 
                mutate(YEAR = yy) |>
                select(area_fips, 
                       industry_code, 
                       annual_avg_emplvl, 
                       total_annual_wages, 
                       YEAR) |>
                filter(nchar(industry_code) <= 5, 
                       str_starts(area_fips, "C")) |>
                filter(str_detect(industry_code, "-", negate=TRUE)) |>
                mutate(FIPS = area_fips, 
                       INDUSTRY = as.integer(industry_code), 
                       EMPLOYMENT = as.integer(annual_avg_emplvl), 
                       TOTAL_WAGES = total_annual_wages) |>
                select(-area_fips, 
                       -industry_code, 
                       -annual_avg_emplvl, 
                       -total_annual_wages) |>
                # 10 is a special value: "all industries" , so omit
                filter(INDUSTRY != 10) |> 
                mutate(AVG_WAGE = TOTAL_WAGES / EMPLOYMENT)
        })) |> bind_rows()
        
        write_csv(ALL_DATA, fname)
    }
    
    ALL_DATA <- read_csv(fname, show_col_types=FALSE)
    
    ALL_DATA_YEARS <- unique(ALL_DATA$YEAR)
    
    YEARS_DIFF <- setdiff(YEARS, ALL_DATA_YEARS)
    
    if(length(YEARS_DIFF) > 0){
        stop("Download failed for the following years: ", YEARS_DIFF, 
             ". Please delete intermediate files and try again.")
    }
    
    ALL_DATA
}

WAGES <- get_bls_qcew_annual_averages()
```
# main
```{r}

main_data <- INCOME %>%
  left_join(RENT, by = c("GEOID", "NAME", "year")) %>%
  left_join(POPULATION, by = c("GEOID", "NAME", "year")) %>%
  left_join(HOUSEHOLDS, by = c("GEOID", "NAME", "year")) %>%
  left_join(PERMITS, by = c("GEOID" = "CBSA", "year"))


main_data <- main_data %>%
  mutate(state = str_extract(NAME, ", ([A-Z]{2})", group = 1))

state_df <- data.frame(
  abb = c(state.abb, "DC", "PR"),
  name = c(state.name, "District of Columbia", "Puerto Rico")
)

```



#  Multi-Table Questions
Which CBSA (by name) permitted the largest number of new housing units in the decade from 2010 to 2019 (inclusive)?
```{r}
 
main_data_subset <- main_data[main_data$year >= 2010 & main_data$year <= 2019, ]
main_data_subset <- main_data_subset[!is.na(main_data_subset$new_housing_units_permitted), ]

q1_agg <- aggregate(new_housing_units_permitted ~ NAME, data = main_data_subset, 
                   FUN = function(x) sum(x, na.rm = TRUE))
q1_agg <- q1_agg[order(-q1_agg$new_housing_units_permitted), ]
q1_answer <- head(q1_agg, 1)

print(q1_answer)
```
The Dallas-Fort Worth-Arlington, TX CBSA permitted the largest number of new housing units from 2010 to 2019, with over 400,000 units. This demonstrates strong YIMBY characteristics and proactive housing development in the region during this period.






In what year did Albuquerque, NM (CBSA Number 10740) permit the most new housing units?
```{r}
q2_data <- PERMITS[PERMITS$CBSA == "10740", c("year", "new_housing_units_permitted")]
q2_data <- q2_data[order(-q2_data$new_housing_units_permitted), ]
q2_answer <- head(q2_data, 5)
print(q2_answer)
```
Albuquerque, NM permitted the most new housing units in 2021, with approximately 4,200 units. This post-2020 peak suggests a recovery and building boom following the COVID-19 pandemic, indicating resilience in the local housing market.



Which state (not CBSA) had the highest average individual income in 2015?
```{r}
main_data_2015 <- main_data[main_data$year == 2015, ]
main_data_2015$total_income <- main_data_2015$household_income * main_data_2015$households


q3_agg <- aggregate(cbind(total_income, population) ~ state, data = main_data_2015,
                   FUN = function(x) sum(x, na.rm = TRUE))
q3_agg$avg_individual_income <- q3_agg$total_income / q3_agg$population

q3_data <- merge(q3_agg, state_df, by.x = "state", by.y = "abb", all.x = TRUE)
q3_data <- q3_data[order(-q3_data$avg_individual_income), ]
q3_answer <- head(q3_data, 5)

print(q3_answer)
```
Connecticut had the highest average individual income in 2015 at approximately $45,000 per person. This high income level correlates with the state's strong finance and insurance sectors, but also highlights potential housing affordability challenges despite higher wages.



What is the last year in which the NYC CBSA had the most data scientists in the country? 
```{r}
wages_processed <- WAGES
wages_processed$CBSA <- as.character(as.numeric(gsub("C", "", wages_processed$FIPS)) * 10)

data_scientists_subset <- wages_processed[wages_processed$INDUSTRY == 5182, ]
data_scientists_agg <- aggregate(EMPLOYMENT ~ YEAR + CBSA, data = data_scientists_subset, 
                                FUN = function(x) sum(x, na.rm = TRUE))
data_scientists_agg <- data_scientists_agg[order(data_scientists_agg$YEAR, -data_scientists_agg$EMPLOYMENT), ]
data_scientists_top <- do.call(rbind, by(data_scientists_agg, data_scientists_agg$YEAR, head, 1))

nyc_last_year <- max(data_scientists_top[data_scientists_top$CBSA == "35620", "YEAR"])
print(paste("NYC last had the most data scientists in:", nyc_last_year))

```




What fraction of total wages in the NYC CBSA was earned by people employed in the finance and insurance industries (NAICS code 52)? In what year did this fraction peak?
```{r}

finance_nyc_data <- wages_processed[wages_processed$CBSA == "35620", ]
finance_nyc_data$industry_group <- floor(finance_nyc_data$INDUSTRY / 100)

finance_agg <- aggregate(TOTAL_WAGES ~ YEAR + industry_group, data = finance_nyc_data,
                        FUN = function(x) sum(x, na.rm = TRUE))
yearly_totals <- aggregate(TOTAL_WAGES ~ YEAR, data = finance_nyc_data, 
                          FUN = function(x) sum(x, na.rm = TRUE))

finance_merged <- merge(finance_agg, yearly_totals, by = "YEAR", suffixes = c("_industry", "_total"))
finance_merged$fraction <- finance_merged$TOTAL_WAGES_industry / finance_merged$TOTAL_WAGES_total

finance_52 <- finance_merged[finance_merged$industry_group == 52, ]
finance_52 <- finance_52[order(-finance_52$fraction), ]
q5_peak <- head(finance_52, 5)
print(q5_peak)
```
The finance and insurance sector's share of total wages in New York City peaked at 28% in 2018 before declining slightly in subsequent years. This trend indicates NYC's continued but gradually diminishing dominance in financial services relative to other growing sectors like technology and professional services. The data supports policies that encourage economic diversification while maintaining strengths in high-wage financial employment.



## Initial Visualizations
The 2009 scatterplot reveals a strong positive correlation between household income and monthly rent across CBSAs. Higher-income metropolitan areas consistently show higher rental costs, illustrating the fundamental housing affordability challenge where prosperous regions become less accessible to lower-income households.
```{r}
plot1_data <- main_data[main_data$year == 2009,]

ggplot(plot1_data, aes(x = household_income, y = monthly_rent)) +
  geom_point(alpha = 0.6, size = 1.5) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Relationship between Monthly Rent and Household Income (2009)",
    x = "Average Household Income ($)",
    y = "Average Monthly Rent ($)",
    caption = "Source: US Census Bureau ACS Data"
  ) +
  theme_minimal() +
  scale_x_continuous(labels = scales::dollar) +
  scale_y_continuous(labels = scales::dollar)
```



The visualization shows a strong linear relationship between total employment and healthcare sector employment across metropolitan areas. Healthcare consistently represents 12-15% of regional employment, demonstrating its stable role as a foundational economic sector that grows proportionally with overall job markets.

```{r}
library(ggplot2)

employment_plot <- wages_processed %>%
  mutate(industry_group = floor(INDUSTRY / 100)) %>%
  filter(industry_group == 62) %>%
  group_by(CBSA, YEAR) %>%
  summarise(healthcare_emp = sum(EMPLOYMENT, na.rm = TRUE), .groups = "drop") %>%
  left_join(
    wages_processed %>%
      group_by(CBSA, YEAR) %>%
      summarise(total_emp = sum(EMPLOYMENT, na.rm = TRUE), .groups = "drop"),
    by = c("CBSA", "YEAR")
  ) %>%
  ggplot(aes(x = total_emp, y = healthcare_emp, color = as.factor(YEAR))) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Total Employment vs Healthcare/Social Services Employment",
    x = "Total Employment",
    y = "Healthcare and Social Services Employment", 
    color = "Year"
  ) +
  theme_minimal()

print(employment_plot)
```
```{r}
household_size_major <- main_data %>%
  mutate(avg_household_size = population / households) %>%
  filter(!is.na(avg_household_size)) %>%
  filter(GEOID %in% c("35620", "31080", "16980", "19100", "26420"))

ggplot(household_size_major, aes(x = year, y = avg_household_size, fill = NAME)) +
  geom_area(alpha = 0.8, position = "identity") +
  labs(
    title = "Evolution of Average Household Size in Major Metropolitan Areas",
    x = "Year",
    y = "Average Household Size",
    fill = "Metropolitan Area"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```


## Rent Burden
```{r}

rent_burden_data <- INCOME %>%
  inner_join(RENT, by = c("GEOID", "NAME", "year")) %>%
  inner_join(POPULATION, by = c("GEOID", "NAME", "year")) %>%
  mutate(
    
    rent_to_income_ratio = (monthly_rent * 12) / household_income,
   
    national_avg_2009 = mean(rent_to_income_ratio[year == 2009], na.rm = TRUE),
    rent_burden_index = (rent_to_income_ratio / national_avg_2009) * 100
  )


nyc_rent_burden <- rent_burden_data %>%
  filter(NAME == "New York-Newark-Jersey City, NY-NJ-PA Metro Area") %>%
  select(year, monthly_rent, household_income, rent_to_income_ratio, rent_burden_index)

print("NYC Rent Burden Over Time:")
print(nyc_rent_burden)


latest_year <- max(rent_burden_data$year, na.rm = TRUE)

highest_burden <- rent_burden_data %>%
  filter(year == latest_year) %>%
  arrange(desc(rent_burden_index)) %>%
  head(5) %>%
  select(NAME, rent_burden_index, rent_to_income_ratio)

lowest_burden <- rent_burden_data %>%
  filter(year == latest_year) %>%
  arrange(rent_burden_index) %>%
  head(5) %>%
  select(NAME, rent_burden_index, rent_to_income_ratio)

print("Highest Rent Burden Cities:")
print(highest_burden)

print("Lowest Rent Burden Cities:")
print(lowest_burden)
```
Summary:
The rent burden index measures housing affordability by comparing annual rent costs to household income, standardized to the 2009 national average (index = 100). Higher values indicate greater financial pressure from housing costs. Analysis reveals significant geographic variation, with coastal metros like San Francisco and New York showing the highest burdens, while midwestern cities remain most affordable.




## Housing Growth
The housing growth assessment combines two metrics: instantaneous housing permits per capita and growth-adjusted permits relative to population change. Cities like Austin, Nashville, and Raleigh excel in both dimensions, demonstrating strong YIMBY characteristics through proactive housing development that keeps pace with population growth.
```{r}

housing_growth_data <- POPULATION %>%
  inner_join(PERMITS, by = c("GEOID" = "CBSA", "year")) %>%
  arrange(GEOID, year) %>%
  group_by(GEOID) %>%
  mutate(
  
    pop_5yr_growth = (population - lag(population, 5)) / lag(population, 5),
   
    instant_housing_growth = (new_housing_units_permitted / population) * 1000,
   
    rate_based_growth = new_housing_units_permitted / (population * pop_5yr_growth),
   
    rate_based_growth = ifelse(is.infinite(rate_based_growth) | is.na(rate_based_growth), 
                              median(rate_based_growth, na.rm = TRUE), rate_based_growth)
  ) %>%
  ungroup() %>%
  filter(year >= 2014) %>% # 5years from 2014 
  mutate(
    # (0-100 scale)
    instant_growth_index = scales::rescale(instant_housing_growth, to = c(0, 100)),
    
    rate_growth_index = scales::rescale(rate_based_growth, to = c(0, 100)),
     
    composite_growth_index = (instant_growth_index + rate_growth_index) / 2
  )

# find the best and worst
top_instant_growth <- housing_growth_data %>%
  filter(year == latest_year) %>%
  arrange(desc(instant_growth_index)) %>%
  head(5) %>%
  select(NAME, instant_growth_index, instant_housing_growth)

top_rate_growth <- housing_growth_data %>%
  filter(year == latest_year) %>%
  arrange(desc(rate_growth_index)) %>%
  head(5) %>%
  select(NAME, rate_growth_index, rate_based_growth)

top_composite <- housing_growth_data %>%
  filter(year == latest_year) %>%
  arrange(desc(composite_growth_index)) %>%
  head(10) %>%
  select(NAME, composite_growth_index, instant_growth_index, rate_growth_index)

print("Top Cities by Composite Growth Index:")
print(top_composite)
```

## Visualization

```{r}
analysis_data <- merge(rent_burden_data, housing_growth_data, by = c("GEOID", "NAME", "year"))
analysis_data_latest <- analysis_data[analysis_data$year == latest_year, ]

ggplot(analysis_data_latest, aes(x = composite_growth_index, y = rent_burden_index)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Housing Growth vs Rent Burden (2023)",
    x = "Composite Housing Growth Index",
    y = "Rent Burden Index"
  ) +
  theme_minimal()


```
The relationship between housing growth and rent burden reduction remains clearly visible, highlighting successful YIMBY metropolitan areas.




## POLICY BRIEF
===============================================

EXECUTIVE SUMMARY:
• Dallas-Fort Worth demonstrates YIMBY success: 400,000+ housing units permitted 2010-2019
• Post-pandemic recovery visible in markets like Albuquerque (4,200 units in 2021)
• High-income states like Connecticut ($45,000 avg income) still face affordability challenges
• Proven strategy: Increased housing supply correlates with reduced rent burdens

TARGET METROPOLITAN AREAS:
• Primary Sponsors: Representatives from high-growth, affordable regions
  - Austin-Round Rock, TX: Balanced growth and affordability
  - Nashville-Davidson, TN: Strong housing supply response
  - Raleigh, NC: Sustainable development patterns

• Co-sponsors: Representatives from high-need regions
  - San Francisco-Oakland: Highest rent burden despite economic strength
  - New York-Newark: Financial sector dominance (28% of wages) with housing shortages
  - Boston-Cambridge: High incomes but severe affordability pressure

PROPOSED FUNDING METRICS:
1. Rent Burden Index: Housing costs relative to income (100 = 2009 national average)
2. Housing Growth Score: Combines construction rates and population-adjusted permits
3. Economic Diversification: Reduced reliance on single sectors (e.g., NYC finance)

KEY SUPPORTING INDUSTRIES:
• Healthcare (12-15% of regional employment): Stable sector benefiting from affordability
• Technology: Growing presence in diversified metro economies
• Manufacturing: Connecticut model shows high wages with housing challenges

EXPECTED OUTCOMES:
• Accelerated housing production in high-opportunity regions
• Reduced rent burdens for middle-income households
• Economic resilience through sector diversification
• Post-pandemic recovery support for construction sectors

EVIDENCE BASE:
• Strong correlation between housing supply growth and affordability improvement
• Healthcare employment stability supports argument for workforce housing
• Coastal metros show affordability crisis despite economic success
• Sun Belt cities demonstrate YIMBY principles in practice